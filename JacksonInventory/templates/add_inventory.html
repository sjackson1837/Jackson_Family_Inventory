<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Inventory</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .flash-message {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="flash-message alert alert-success" id="flash-success">
            Product found successfully!
        </div>
        <div class="flash-message alert alert-danger" id="flash-error">
            Product not found or an error occurred.
        </div>
        <form method="POST" action="{{ url_for('add_inventory') }}">
            <h1>Add Item Page</h1>
            <br/>
            <div id="barcodeContainer">
                <label for="barcode">Barcode:</label>
                <input type="text" class="form-control" id="barcode" name="barcode" placeholder="Enter barcode" value="{{ barcode if barcode else '' }}" required><br>
            </div>

            <div id="productDataContainer" style="display: none;">
                <textarea id="productname" name="productname"></textarea><br/>
                <div>
                    <img src="" id="productimage_show" alt="" style="max-width: 150px; max-height: 150px; object-fit: contain;"><br/>
                    <button type="button" onclick="changeImageSrc(); return false;">Delete Picture</button>
                    <input type="text" id="productimage_input" name="productimage" style="display: none;">
                </div>

                <div>
                    <label>Qty:</label>
                    <button type="button" onclick="decrementQty()">-</button>
                    <input type="text" id="qty" name="qty" required>
                    <button type="button" onclick="incrementQty()">+</button>
                </div>
                <br/>

                <div>
                    <label>Min Qty:</label>
                    <button type="button" onclick="decrementMinQty()">-</button>
                    <input type="text" id="minqty" name="minqty" required>
                    <button type="button" onclick="incrementMinQty()">+</button>
                </div>
                <br/>

                <label hidden="true" for="productimage">Product Image</label>
                <input hidden="true" type="text" id="productimage" name="productimage">

                <label for="category">Category</label>
                <select id="category" name="category_id" required onchange="updateSubcategories()">
                    <option value="">-- Select Category --</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.category }}</option>
                    {% endfor %}
                </select>
                <br/>

                <label for="subcategory">Sub Category</label>
                <select id="subcategory" name="subcategory_id">
                    <option value=" ">-- Select Subcategory --</option>
                </select>
                <br/>
            </div>

            <div id="product-details" class="d-none">
                <h2 id="product-name"></h2>
                <img id="product-image" src="" alt="Product Image" class="img-fluid">
                <p id="product-description"></p>
            </div>

            <div>
                <input type="submit" value="Add Item">
                <input type="button" value="Cancel" onclick="reloadPage()">
            </div>
        </form>
    </div>

    <audio id="sound-positive" src="static/sounds/positive.mp3" preload="auto"></audio>
    <audio id="sound-negative" src="static/sounds/negative.mp3" preload="auto"></audio>


    <script>
        let barcodeTimeout;

document.getElementById('barcode').addEventListener('input', function() {
    clearTimeout(barcodeTimeout);
    barcodeTimeout = setTimeout(() => {
        const barcode = document.getElementById('barcode').value;
        fetchProductDetails(barcode);
    }, 1500);
});

function fetchProductDetails(barcode) {
    fetchBarcodeFromDatabase(barcode)
        .then(data => {
            if (data.found) {
                incrementQuantity(data);
            } else {
                fetchProductInfo(barcode)
                    .then(product => {
                        if (product) {
                            displayProductInfo(product);
                        } else {
                            displayCustomProductForm();
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        displayErrorMessage();
                    });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            displayErrorMessage();
        });
}

function fetchBarcodeFromDatabase(barcode) {
    // Simulate fetching data from the database
    return new Promise((resolve, reject) => {
        // Replace this with actual database query
        // For demonstration, returning a sample object
        setTimeout(() => {
            resolve({ found: false }); // Assume barcode not found
        }, 500);
    });
}

function incrementQuantity(data) {
    // Increment quantity logic
}

function fetchProductInfo(barcode) {
    // Fetch product info from external API
    return fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Product not found or an error occurred');
            }
            return response.json();
        })
        .then(data => {
            if (data && data.product && data.status === 1) {
                return data.product;
            } else {
                throw new Error('Product not found');
            }
        });
}

function displayProductInfo(product) {
    // Display product info
    const productName = document.getElementById('product-name');
    const productImage = document.getElementById('product-image');
    const productDescription = document.getElementById('product-description');
    const productDataContainer = document.getElementById('productDataContainer');
    const productname = document.getElementById('productname');
    const productimage_input = document.getElementById('productimage_input');

    productName.textContent = product.product_name || 'No product name available';
    productImage.src = product.image_url || '';
    productDescription.textContent = product.ingredients_text || 'No description available';

    // Display product data in form and make editable
    productname.value = product.product_name || '';
    productimage_input.value = product.image_url || '';
    productDataContainer.style.display = 'block';

    // Display product details section
    document.getElementById('product-details').classList.remove('d-none');
    document.getElementById('flash-success').style.display = 'block';
    document.getElementById('sound-positive').play().catch(error => console.error('Failed to play positive sound:', error));
}

function displayCustomProductForm() {
    // Display custom product form
    // Example: document.getElementById('productDataContainer').innerHTML = ...
    // For demonstration, setting a default image
    document.getElementById('productimage_show').src = 'https://st4.depositphotos.com/14953852/22772/v/450/depositphotos_227725020-stock-illustration-image-available-icon-flat-vector.jpg';
}

function displayErrorMessage() {
    // Display error message
    // Example: document.getElementById('flash-error').style.display = 'block';
}

function reloadPage() {
    window.location.reload();
}
    </script>
    <!-- Use full jQuery for AJAX support -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
